stages:
  - deploy

deploy:
  stage: deploy
  image: node:16
  variables:
    SSH_DEST_STAGING: forge@8.213.19.215:/var/www/front.klinikatech.com/
    SSH_DEST_MAIN: root@8.213.23.97:/var/www/new.klinikatech.com/
  when: manual
  only:
    - main
    - staging
  before_script:
    - |
      which ssh-agent || ( apt-get update -y && apt-get install openssh-client coreutils -y --no-install-recommends )
      eval $(ssh-agent -s)
      echo "$SSH_PRIVATE_KEY" | base64 -d | ssh-add -
      mkdir -pv ~/.ssh
      if [[ -f /.dockerenv ]]; then
        echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
      fi
  script:
    - apt-get update -y
    - apt-get install -y rsync
    - npm install
    - if [ "$CI_COMMIT_BRANCH" = "main" ]; then npm run build:prod; else npm run build:dev; fi
    - if [ "$CI_COMMIT_BRANCH" = "main" ]; then rsync -avz --del ./build/ $SSH_DEST_MAIN; else rsync -avz --del ./build/ $SSH_DEST_STAGING; fi
